<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Comments</title>
<style>
body { font-family: serif; max-width: 700px; margin: 2em auto; }
.comment { margin-left: 1em; border-left: 1px solid #ccc; padding-left: 1em; }
textarea { width: 100%; height: 80px; }
button { margin-top: 0.5em; }
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h3>Comments</h3>
<div id="comments"></div>

<h4>Leave a comment</h4>
<input id="name" placeholder="Name (optional)"><br><br>
<input id="email" placeholder="Email (optional)"><br><br>
<textarea id="content" placeholder="Your comment"></textarea><br>
<button id="postBtn">Post</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  'https://pidzgdrdgqgsayfoxqba.supabase.co',
  'sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z'
);
document.getElementById('postBtn').addEventListener('click', function() {
  postComment(null);
});
const page = window.location.pathname;

async function loadComments() {
  const { data } = await supabase
    .from('comments')
    .select('*')
    .eq('page', page)
    .order('created_at');

  document.getElementById('comments').innerHTML = renderTree(data);
}

function renderTree(comments, parent = null) {
  return comments
    .filter(c => c.parent_id === parent)
    .map(c => `
      <div class="comment">
        <strong>${c.name || 'Anonymous'}</strong><br>
        ${c.content}<br>
        <button onclick="replyPrompt('${c.id}')">Reply</button>
        ${renderTree(comments, c.id)}
      </div>
    `).join('');
}

async function postComment(parentId) {
  const content = document.getElementById('content').value;
  if (!content) return;

  await supabase.from('comments').insert({
    parent_id: parentId,
    page,
    name: document.getElementById('name').value,
    email: document.getElementById('email').value,
    content
  });

  document.getElementById('content').value = '';
  loadComments();
}

function replyPrompt(parentId) {
  const text = prompt('Reply:');
  if (!text) return;

  supabase.from('comments').insert({
    parent_id: parentId,
    page,
    content: text
  }).then(loadComments);
}

loadComments();
</script>

</body>
</html>
