<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Comments Widget</title>

  <style>
    body {
      font-family: serif;
      max-width: 700px;
      margin: 2em auto;
    }
    .comment {
      margin-bottom: 1em;
      padding-left: 1em;
      border-left: 1px solid #ccc;
    }
    .reply {
      margin-left: 20px;
      margin-top: 1em;
      border-left: 2px solid #ddd;
      padding-left: 15px;
    }
    textarea {
      width: 100%;
      height: 80px;
    }
    button {
      margin-top: 0.5em;
    }
    .replying-to {
      background-color: #f0f0f0;
      padding: 5px;
      margin-bottom: 10px;
      border-radius: 3px;
    }
    .cancel-reply {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.9em;
      margin-left: 10px;
    }
    #debug {
      background: #f5f5f5;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 12px;
      color: #666;
    }
  </style>

  <!-- Load Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h3>Comments</h3>

<!-- Debug info -->
<div id="debug" style="display: none;">
  <strong>Debug Info:</strong><br>
  Current Parent ID: <span id="debug-parent">null</span><br>
  Replying to: <span id="debug-reply-to">none</span>
</div>

<!-- Comment form -->
<h4>Leave a comment</h4>
<input id="name" placeholder="Name (optional)"><br><br>
<input id="email" type="email" placeholder="Your Email"><br><br>

<div id="reply-info" style="display: none;" class="replying-to">
  <span id="reply-target">Replying to comment...</span>
  <button class="cancel-reply" onclick="cancelReply()">Cancel</button>
</div>

<textarea id="content" placeholder="Your comment"></textarea><br>
<button id="postBtn" onclick="postComment()">Post Comment</button>

<!-- Comment container -->
<div id="comments"></div>

<script>
/* ================================
   Supabase initialization
   ================================ */

// Enable debug mode - remove this in production
const DEBUG = true;
if (DEBUG) {
  document.getElementById('debug').style.display = 'block';
}

const sb = supabase.createClient(
  'https://pidzgdrdgqgsayfoxqba.supabase.co',
  'sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z'
);

// Global variables
let currentParentId = null;
let replyingToName = null;

/* ================================
   Update debug display
   ================================ */
function updateDebugInfo() {
  if (DEBUG) {
    document.getElementById('debug-parent').textContent = currentParentId;
    document.getElementById('debug-reply-to').textContent = replyingToName || 'none';
  }
}

/* ================================
   Post comment
   ================================ */
async function postComment() {
  console.log("=== POST COMMENT CALLED ===");
  console.log("Current parentId:", currentParentId);
  
  const name = document.getElementById('name').value.trim() || null;
  const email = document.getElementById('email').value.trim() || null;
  const content = document.getElementById('content').value.trim();

  console.log("Form values:", { name, email, content });

  if (!content) {
    alert('Please write a comment.');
    return;
  }

  // Prepare the data to insert
  const commentData = {
    name: name,
    email: email,
    content: content,
    parent_id: currentParentId,
    page: 'life-and-death-in-gaza'
  };

  console.log("Data to insert:", commentData);

  try {
    // Insert the comment into Supabase
    const { data, error } = await sb.from('comments').insert([commentData]).select();
    
    if (error) {
      console.error("Supabase error:", error);
      alert('Error posting comment: ' + error.message);
      return;
    }
    
    console.log("Insert successful:", data);

    // Clear the form and reset state
    resetForm();
    
    // Reload the comments
    loadComments();
    
    alert('Comment posted successfully!');
    
  } catch (err) {
    console.error("Unexpected error:", err);
    alert('Unexpected error: ' + err.message);
  }
}

/* ================================
   Reset form to default state
   ================================ */
function resetForm() {
  console.log("Resetting form");
  
  document.getElementById('name').value = '';
  document.getElementById('email').value = '';
  document.getElementById('content').value = '';
  document.getElementById('content').placeholder = 'Your comment';
  
  // Hide reply info
  document.getElementById('reply-info').style.display = 'none';
  
  // Reset button
  document.getElementById('postBtn').innerHTML = 'Post Comment';
  
  // Reset global variables
  currentParentId = null;
  replyingToName = null;
  
  updateDebugInfo();
}

/* ================================
   Cancel reply
   ================================ */
function cancelReply() {
  console.log("Cancelling reply");
  resetForm();
}

/* ================================
   Reply to comment
   ================================ */
function replyToComment(parentId, commenterName) {
  console.log("=== REPLY TO COMMENT ===");
  console.log("parentId:", parentId);
  console.log("commenterName:", commenterName);
  
  // Set the parentId
  currentParentId = parentId;
  replyingToName = commenterName;
  
  // Update the UI to show we're replying
  document.getElementById('content').placeholder = `Reply to ${commenterName}...`;
  document.getElementById('reply-target').textContent = `Replying to ${commenterName}`;
  document.getElementById('reply-info').style.display = 'block';
  
  // Update button text
  document.getElementById('postBtn').innerHTML = 'Post Reply';
  
  // Update debug info
  updateDebugInfo();
  
  // Scroll to the comment form
  document.getElementById('content').focus();
  
  console.log("Reply mode activated for parentId:", currentParentId);
}

/* ================================
   Load comments with proper nesting
   ================================ */
async function loadComments() {
  console.log("Loading comments...");
  
  try {
    const { data, error } = await sb
      .from('comments')
      .select('*')
      .eq('page', 'life-and-death-in-gaza')
      .order('created_at', { ascending: true });

    if (error) {
      console.error("Error loading comments:", error);
      return;
    }

    console.log("Loaded comments:", data);

    const container = document.getElementById('comments');
    container.innerHTML = '';

    if (data.length === 0) {
      container.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
      return;
    }

    // Helper function to display comments recursively
    function displayComments(comments, parentId = null, depth = 0) {
      // Filter comments by parentId
      const filteredComments = comments.filter(c => {
        // For top-level comments (null parent_id)
        if (parentId === null) {
          return c.parent_id === null || c.parent_id === 0;
        }
        // For replies
        return c.parent_id === parentId;
      });

      // Display each comment and its replies
      filteredComments.forEach(comment => {
        const div = document.createElement('div');
        const commenterName = comment.name ? comment.name : 'Anonymous';
        
        // Add indentation for replies
        const marginLeft = depth * 30;
        div.style.marginLeft = `${marginLeft}px`;
        div.style.marginTop = '10px';
        div.style.padding = '10px';
        div.style.borderLeft = depth > 0 ? '2px solid #ddd' : 'none';
        div.style.backgroundColor = depth > 0 ? '#f9f9f9' : 'transparent';
        
        // Display comment
        div.innerHTML = `
          <div>
            <strong>${commenterName}</strong>
            <span style="color: #666; font-size: 0.9em; margin-left: 10px;">
              ${new Date(comment.created_at).toLocaleDateString()} 
              ${new Date(comment.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
            </span>
          </div>
          <div style="margin: 10px 0;">${comment.content}</div>
          <button onclick="replyToComment(${comment.id}, '${commenterName.replace(/'/g, "\\'")}')">
            Reply
          </button>
        `;
        
        container.appendChild(div);
        
        // Recursively display replies
        displayComments(comments, comment.id, depth + 1);
      });
    }

    // Start displaying from top-level comments
    displayComments(data);
    
  } catch (err) {
    console.error("Unexpected error loading comments:", err);
    document.getElementById('comments').innerHTML = '<p style="color: red;">Error loading comments. Please refresh the page.</p>';
  }
}

/* ================================
   Test Supabase connection
   ================================ */
async function testConnection() {
  try {
    console.log("Testing Supabase connection...");
    const { data, error } = await sb.from('comments').select('count', { count: 'exact', head: true });
    
    if (error) {
      console.error("Connection test failed:", error);
      alert('Cannot connect to database. Please check your Supabase configuration.');
    } else {
      console.log("Connection test successful. Total comments:", data);
    }
  } catch (err) {
    console.error("Connection test error:", err);
  }
}

/* ================================
   Initial load
   ================================ */
window.addEventListener('DOMContentLoaded', () => {
  console.log("DOM loaded, initializing...");
  
  // Test connection first
  testConnection();
  
  // Load comments
  loadComments();
  
  // Initialize debug info
  updateDebugInfo();
  
  // Add event listener for Enter key in textarea
  document.getElementById('content').addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      postComment();
    }
  });
});
</script>

</body>
</html>
