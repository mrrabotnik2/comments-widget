<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Comments Widget</title>
<style>
body { font-family: serif; max-width: 700px; margin: 2em auto; }
.comment { margin-left: 1em; border-left: 1px solid #ccc; padding-left: 1em; margin-bottom: 1em; }
textarea { width: 100%; height: 80px; }
button { margin-top: 0.5em; }
</style>

<!-- 1️⃣ Load Supabase JS library first -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h3>Comments</h3>
<div id="comments"></div>

<h4>Leave a comment</h4>
<input id="name" placeholder="Name (optional)"><br><br>
<input id="email" placeholder="Email (optional)"><br><br>
<textarea id="content" placeholder="Your comment"></textarea><br>
<button id="postBtn">Post Comment</button>

<script>
// 2️⃣ Initialize Supabase client
const supabase = supabase.createClient(
  'https://pidzgdrdgqgsayfoxqba.supabase.co',   // Replace with your Supabase URL
  'sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z' // Replace with your anon key
);

// 3️⃣ Post a comment
async function postComment(parentId = null) {
  const name = document.getElementById('name').value || null;
  const email = document.getElementById('email').value || null;
  const content = document.getElementById('content').value;

  if (!content.trim()) {
    alert("Please write a comment before posting.");
    return;
  }

  const { data, error } = await supabase
    .from('comments')
    .insert([{
      id: crypto.randomUUID(),
      parent_id: parentId,
      page: 'life-and-death-in-gaza', // Replace with your page identifier
      name,
      email,
      content
    }]);

  if (error) {
    console.error(error);
    alert("Error posting comment.");
  } else {
    document.getElementById('name').value = '';
    document.getElementById('email').value = '';
    document.getElementById('content').value = '';
    loadComments();
  }
}

// 4️⃣ Load all comments for this page
async function loadComments() {
  const { data, error } = await supabase
    .from('comments')
    .select('*')
    .eq('page', 'life-and-death-in-gaza')
    .order('created_at', { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  const container = document.getElementById('comments');
  container.innerHTML = '';

  data.forEach(comment => {
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `<strong>${comment.name || 'Anonymous'}</strong>: ${comment.content}`;
    container.appendChild(div);
  });
}

// 5️⃣ Attach click listener AFTER Supabase is ready
document.getElementById('postBtn').addEventListener('click', () => postComment());

// 6️⃣ Load comments on page load
loadComments();
</script>

</body>
</html>
