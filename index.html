<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Comments Widget</title>

  <style>
    body {
      font-family: serif;
      max-width: 700px;
      margin: 2em auto;
    }
    .comment {
      margin-bottom: 1em;
      padding-left: 1em;
      border-left: 1px solid #ccc;
    }
    .reply {
      margin-left: 20px;
      margin-top: 1em;
      border-left: 2px solid #ddd;
      padding-left: 15px;
    }
    textarea {
      width: 100%;
      height: 80px;
    }
    button {
      margin-top: 0.5em;
    }
  </style>

  <!-- Load Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h3>Comments</h3>

<!-- Comment form -->
<h4>Leave a comment</h4>
<input id="name" placeholder="Name (optional)"><br><br>
<input id="email" type="email" placeholder="Your Email"><br><br>

<textarea id="content" placeholder="Your comment"></textarea><br>
<button id="postBtn" onclick="postComment()">Post Comment</button>

<!-- Comment container -->
<div id="comments"></div>

<script>
/* ================================
   Supabase initialization
   ================================ */

const sb = supabase.createClient(
  'https://pidzgdrdgqgsayfoxqba.supabase.co',
  'sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z'
);

/* ================================
   Post comment
   ================================ */
async function postComment(parentId = null) {
  const name = document.getElementById('name').value || null;
  const email = document.getElementById('email').value.trim() || null;
  const content = document.getElementById('content').value.trim();

  if (!content) {
    alert('Please write a comment.');
    return;
  }

  console.log(`Posting comment with parentId: ${parentId}`); // Log to check

  // Insert the comment along with name, email, content, and parent_id into Supabase
  const { error } = await sb.from('comments').insert({
    name: name,
    email: email,  // Insert email value
    content: content,
    parent_id: parentId,  // Parent comment ID (null for main comments)
    page: 'life-and-death-in-gaza'
  });

  if (error) {
    console.error(error);
    alert('Error posting comment');
    return;
  }

  // Clear the input fields after posting the comment
  document.getElementById('name').value = '';
  document.getElementById('email').value = '';  // Clear email field after submission
  document.getElementById('content').value = '';

  // Reload the comments to display the newly posted comment
  loadComments();
}

/* ================================
   Load comments
   ================================ */
async function loadComments() {
  const { data, error } = await sb
    .from('comments')
    .select('*')
    .eq('page', 'life-and-death-in-gaza')
    .order('created_at', { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  console.log("Loaded comments:", data); // Log to check

  const container = document.getElementById('comments');
  container.innerHTML = ''; // Clear existing comments before reloading

  // Helper function to display comments
  function displayComments(comments, parentId = null) {
    // Filter and display the comments that match the parentId
    comments.filter(c => c.parent_id === parentId).forEach(c => {
      const div = document.createElement('div');
      div.className = 'comment';

      const commenterName = c.name ? c.name : 'Anonymous';  // Use "Anonymous" if no name is provided

      // Insert name, content, and a reply button
      div.innerHTML = `<strong>${commenterName}</strong><br>${c.content}<br>
                       <button onclick="replyToComment(${c.id})">Reply</button>`;

      // Append the comment to the container
      container.appendChild(div);

      // Recursively display replies (comments with matching parent_id)
      displayComments(comments, c.id);
    });
  }

  // Call the display function to display main comments
  displayComments(data);
}

/* ================================
   Reply to comment
   ================================ */
function replyToComment(parentId) {
  console.log(`Replying to comment with parentId: ${parentId}`); // Log to check

  // Change the text in the textarea to indicate replying
  document.getElementById('content').placeholder = 'Your reply...';

  // Change the button action to post a reply (with parentId)
  document.getElementById('postBtn').onclick = function() {
    postComment(parentId);  // Post with the correct parentId
  };
}

/* ================================
   Initial load
   ================================ */
loadComments();
</script>

</body>
</html>
